<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OCR eFootball → JSON</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  #json{white-space:pre-wrap;background:#111;color:#0f0;padding:12px;border-radius:8px;min-height:120px}
  #log{white-space:pre-wrap;background:#f6f6f6;padding:8px;border-radius:8px}
  img{max-width:100%;border-radius:8px}
  small{opacity:.65}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>Resultados eFootball → JSON</h1>
  <div class="row">
    <input type="file" id="file" accept="image/*" />
    <button id="run">Procesar</button>
    <small>Todo ocurre en tu navegador.</small>
  </div>
  <p><b>Imagen:</b></p>
  <img id="preview" />
  <p><b>Texto OCR (debug):</b></p>
  <div id="log"></div>
  <p><b>JSON:</b></p>
  <div id="json"></div>

<script>
const STATS_LABELS = [
  "Possession","Shots","Shots on Target","Fouls","Offsides","Corner Kicks",
  "Free Kicks","Passes","Successful Passes","Crosses","Interceptions",
  "Tackles","Saves"
];

const $ = sel => document.querySelector(sel);
const log = msg => { $("#log").textContent = msg; };

$("#file").addEventListener("change", e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  $("#preview").src = URL.createObjectURL(f);
});

$("#run").addEventListener("click", async ()=>{
  const f = $("#file").files?.[0];
  if(!f){ alert("Sube una imagen primero"); return; }

  const { createWorker } = Tesseract;
  const worker = await createWorker("eng");
  const { data:{ text } } = await worker.recognize(f);
  await worker.terminate();

  log(text);

  const parsed = parseEfootball(text);
  $("#json").textContent = JSON.stringify(parsed, null, 2);
});

function parseEfootball(textRaw){
  // Normaliza
  const text = textRaw
    .replace(/\u2013|\u2014|—/g, "-")
    .replace(/[^\S\r\n]+/g, " ")
    .replace(/\r/g,"")
    .trim();

  // 1) Encabezado: Equipo1, g1, g2, Equipo2
  // Varias heurísticas para distintos OCR:
  const headerLine = text.split("\n").find(l =>
    /(\d+).+(\d+)/.test(l) && /%/.test(text) // haya números y luego stats
  ) || text.split("\n")[0];

  let team1="", team2="", g1=null, g2=null;

  // Intento robusto: captura “… <name1> <g1> .* <g2> <name2> …”
  const m1 = headerLine.match(/^(.*?)[^\d]*(\d{1,2})[^\d]+(\d{1,2})[^\w]*(.*)$/i);
  if(m1){
    team1 = cleanTeam(m1[1]);
    g1 = +m1[2];
    g2 = +m1[3];
    team2 = cleanTeam(m1[4]);
  } else {
    // Fallback: busca primera línea con % de posesión y rebobina nombres por arriba
    team1 = "Team A"; team2 = "Team B";
    g1 = g1 ?? 0; g2 = g2 ?? 0;
  }

  // 2) Estadísticas: leemos cada etiqueta conocida y tomamos los dos valores cercanos
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
  const stats = {};
  for(const label of STATS_LABELS){
    const idx = lines.findIndex(l => normalize(l).includes(normalize(label)));
    if(idx !== -1){
      // Busca números en la propia línea o en líneas vecinas
      let ctx = [lines[idx-1], lines[idx], lines[idx+1]].filter(Boolean).join(" ");
      const nums = [...ctx.matchAll(/(\d+%?)/g)].map(x=>x[1]).slice(0, 6);
      // Heurística: los dos primeros números del contexto suelen ser izq/der
      const [left, right] = pickTwoNumbers(nums);
      if(left!=null && right!=null){
        stats[label] = coerce(left, right, label==="Possession");
      }
    }
  }

  return {
    source: "ocr",
    competition: "eFootball",
    result: {
      homeTeam: team1,
      awayTeam: team2,
      homeGoals: g1,
      awayGoals: g2
    },
    stats // { Possession:{home:"59%",away:"41%"}, Shots:{home:6,away:6}, ... }
  };
}

function cleanTeam(s){
  return s.replace(/^\W+|\W+$/g,"")
          .replace(/\s{2,}/g," ")
          .replace(/\bFull Time\b/i,"")
          .trim();
}
function normalize(s){ return s.toLowerCase().replace(/\s+/g," ").trim(); }
function pickTwoNumbers(arr){
  // Prioriza pares separados por texto; si hay 3+, intenta descartar números de etiqueta (“Full Time”, etc.)
  const nums = arr.filter(x => x && /\d/.test(x));
  if(nums.length >= 2) return [nums[0], nums[1]];
  return [null, null];
}
function coerce(a, b, keepPercent=false){
  const va = keepPercent ? a : +a.toString().replace("%","");
  const vb = keepPercent ? b : +b.toString().replace("%","");
  return keepPercent ? { home: a, away: b } : { home: va, away: vb };
}
</script>
</body>
</html>
